// How many pins you want in total (can also expose as ?maxPins=500)
const MAX_PINS = Number(qs.get("maxPins") ?? 500);
const PAGE_SIZE = 100; // API max per page

async function fetchImagesInBbox({ bbox, cap = MAX_PINS }) {
  let out = [];
  // first page
  let url = new URL("https://graph.mapillary.com/images");
  url.searchParams.set("fields", "id,computed_geometry");
  url.searchParams.set("bbox", bbox.join(","));
  url.searchParams.set("limit", String(Math.min(PAGE_SIZE, cap)));
  if (defaults.username) url.searchParams.set("creator_username", defaults.username);

  while (url && out.length < cap) {
    const res = await fetch(url, { headers: { Authorization: `OAuth ${TOKEN}` } });
    if (!res.ok) throw new Error(`API ${res.status}`);
    const j = await res.json();

    if (Array.isArray(j.data)) out.push(...j.data);

    // follow next page if present and we still need more
    const next = j?.paging?.next;
    if (!next || out.length >= cap) break;

    url = new URL(next);
    // (optional) tighten the next page size so we don't over-fetch
    url.searchParams.set("limit", String(Math.min(PAGE_SIZE, cap - out.length)));
  }
  return out.slice(0, cap);
}

async function drawPinsForView() {
  if (!TOKEN || !SHOW_PINS) return;
  status("Loading user pins in viewâ€¦");
  try {
    const images = await fetchImagesInBbox({ bbox: bboxFromMap(map), cap: MAX_PINS });
    pinLayer.clearLayers();
    for (const img of images) {
      const c = img?.computed_geometry?.coordinates; if (!c) continue;
      const latlng = [c[1], c[0]];
      L.circleMarker(latlng, defaultPinStyle)
        .on("click", (e) => { L.DomEvent.stop(e); if (viewer) gotoImage(img.id, latlng); })
        .addTo(pinLayer);
    }
    status(`Pins: ${images.length}`);
  } catch (e) { console.error(e); status("Error loading pins."); }
}
